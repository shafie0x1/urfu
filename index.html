<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ü–µ—Å—Å –∑–∞—Å–µ–ª–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #e0eafc, #cfdef3);
            color: #2c3e50;
            direction: ltr;
            text-align: left;
        }
        h1 {
            font-size: 28px;
            color: #3498db;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        h3 {
            font-size: 20px;
            color: #2980b9;
            margin-top: 25px;
        }
        .checklist {
            max-width: 700px;
            margin: 0 auto;
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .item input[type="checkbox"] {
            margin-right: 12px;
            accent-color: #3498db;
        }
        .item label {
            flex: 1;
            font-size: 16px;
            color: #34495e;
        }
        .completed {
            text-decoration: line-through;
            color: #7f8c8d;
        }
        .input-section {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }
        .input-section input, .input-section select {
            padding: 10px;
            font-size: 16px;
            width: 85%;
            margin: 10px auto;
            border: 2px solid #dcdcdc;
            border-radius: 8px;
            display: block;
            transition: border-color 0.3s ease;
        }
        .input-section input:focus, .input-section select:focus {
            border-color: #3498db;
            outline: none;
        }
        #newStudentInput {
            display: none;
        }
        .input-section button, .checklist button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.3s ease;
        }
        .input-section button:hover, .checklist button:hover {
            transform: scale(1.05);
        }
        .input-section button:disabled, .checklist button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        .photo-upload {
            margin-top: 20px;
            text-align: center;
        }
        .photo-upload input[type="file"] {
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body>
    <h1>Buddy System Checklist</h1>
    <div class="input-section" id="inputSection">
        <input type="text" id="guideName" placeholder="–ò–º—è –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞" required>
        <select id="studentName" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</option>
            <option value="new">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞</option>
        </select>
        <input type="text" id="newStudentInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞">
        <input type="text" id="tripNumber" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ä–µ–π—Å–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã">
        <button id="startChecklist" disabled>–ù–∞—á–∞—Ç—å</button>
    </div>
    <div class="checklist" id="checklist">
        <h3>üöÄ –ü–µ—Ä–µ–¥ –ø—Ä–∏–µ–∑–¥–æ–º</h3>
        <div class="item"><input type="checkbox" id="task1"><label for="task1">–ó–∞–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∏–µ–∑–¥</label></div>
        <div class="item"><input type="checkbox" id="task2"><label for="task2">–ü–∏—à–µ–º –ø–∏—Å—å–º–æ —Å—Ç—É–¥–µ–Ω—Ç—É</label></div>
        <div class="item"><input type="checkbox" id="task3"><label for="task3">–ó–∞–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–∫—Å–∏ –∏ –µ–¥–µ–º –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç</label></div>

        <h3>‚úàÔ∏è –í—Å—Ç—Ä–µ—á–∞ –∏ –ø–µ—Ä–≤–æ–µ –∑–∞—Å–µ–ª–µ–Ω–∏–µ</h3>
        <div class="item"><input type="checkbox" id="task4"><label for="task4">–í—Å—Ç—Ä–µ—á–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ –∞—ç—Ä–æ–ø–æ—Ä—Ç—É</label></div>
        <div class="item"><input type="checkbox" id="task5"><label for="task5">–ó–∞—Å–µ–ª—è–µ–º—Å—è –≤ —Ö–æ—Å—Ç–µ–ª</label></div>

        <h3>üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
        <div class="item"><input type="checkbox" id="task6"><label for="task6">–û–±–º–µ–Ω–∏–≤–∞–µ–º –¥–µ–Ω—å–≥–∏</label></div>
        <div class="item"><input type="checkbox" id="task7"><label for="task7">–ü–æ–∫—É–ø–∞–µ–º –ø–æ–ª–∏—Å –î–ú–°</label></div>
        <div class="item"><input type="checkbox" id="task8"><label for="task8">–î–µ–ª–∞–µ–º –∫–æ–ø–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</label></div>
        <div class="item"><input type="checkbox" id="task9"><label for="task9">–ü—Ä–æ—Ö–æ–¥–∏–º –º–µ–¥–æ—Å–º–æ—Ç—Ä –≤ –º–µ–¥—Å–∞–Ω—á–∞—Å—Ç–∏</label></div>

        <h3>üéì –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤ –£—Ä–§–£</h3>
        <div class="item"><input type="checkbox" id="task10"><label for="task10">–ó–∞—á–∏—Å–ª—è–µ–º—Å—è –≤ –£—Ä–§–£</label></div>
        <div class="item"><input type="checkbox" id="task11"><label for="task11">–ü–æ–ª—É—á–∞–µ–º –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ–±—â–µ–∂–∏—Ç–∏–µ</label></div>
        <div class="item"><input type="checkbox" id="task12"><label for="task12">–û—Ñ–æ—Ä–º–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</label></div>
        <div class="item"><input type="checkbox" id="task13"><label for="task13">–ó–∞—Å–µ–ª—è–µ–º—Å—è –≤ –æ–±—â–µ–∂–∏—Ç–∏–µ</label></div>

        <h3>üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–æ–ø—É—Å–∫</h3>
        <div class="item"><input type="checkbox" id="task14"><label for="task14">–û—Ñ–æ—Ä–º–ª—è–µ–º —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫</label></div>
        <div class="item"><input type="checkbox" id="task15"><label for="task15">–î–µ–ª–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –ø–∞—Å–ø–æ—Ä—Ç–∞</label></div>
        <div class="item"><input type="checkbox" id="task16"><label for="task16">–û—Ñ–æ—Ä–º–ª—è–µ–º –°–ù–ò–õ–°</label></div>
        <div class="item"><input type="checkbox" id="task17"><label for="task17">–î–µ–ª–∞–µ–º –±–∏–æ–º–µ—Ç—Ä–∏—é</label></div>

        <h3>üì∂ –°–≤—è–∑—å –∏ –≥–æ—Å—É—Å–ª—É–≥–∏</h3>
        <div class="item"><input type="checkbox" id="task18"><label for="task18">–ü–æ–∫—É–ø–∞–µ–º —Å–∏–º-–∫–∞—Ä—Ç—É</label></div>
        <div class="item"><input type="checkbox" id="task19"><label for="task19">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –≥–æ—Å—É—Å–ª—É–≥–∏</label></div>
        <div class="item"><input type="checkbox" id="task20"><label for="task20">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —Å–∏–º-–∫–∞—Ä—Ç—É –Ω–∞ –≥–æ—Å—É—Å–ª—É–≥–∞—Ö</label></div>

        <h3>üõÇ –í–∏–∑–∞ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏</h3>
        <div class="item"><input type="checkbox" id="task21"><label for="task21">–ü—Ä–æ—Ö–æ–¥–∏–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –æ—Å–≤–∏–¥–µ—Ç–µ–ª—å—Å—Ç–≤–æ–≤–∞–Ω–∏–µ</label></div>
        <div class="item"><input type="checkbox" id="task22"><label for="task22">–ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –≤–∏–∑—É</label></div>
        <div class="item"><input type="checkbox" id="task23"><label for="task23">–ü—Ä–æ—Ö–æ–¥–∏–º –¥–∞–∫—Ç–∏–ª–æ—Å–∫–æ–ø–∏—é</label></div>

                <h3>üì∏ –§–æ—Ç–æ —Å¬†–ò–°</h3>
        <div class="photo-upload">
            <input type="file" id="studentPhoto" accept="image/*">
            <button id="uploadPhoto">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
        
        <h3>‚úÖ –ì–æ—Ç–æ–≤–æ!</h3>
        <div class="item"><label>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –£—Ä–§–£!</label></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzSsQIEgUr_3FJNhd3bTk3J9Ai6gjkV6AlKKkrgadcLjziBCZ0WjJWiCkqAvafECugY/exec";
        const UPDATE_URL = "https://script.google.com/macros/s/AKfycbzU7qdF-EDLS4z-R9D5AC0w9AJJrlLZpdxz4T872iByq1Mkerdx98KKsGy8iuk1t9PS/exec";
        const guideInput = document.getElementById('guideName');
        const studentSelect = document.getElementById('studentName');
        const newStudentInput = document.getElementById('newStudentInput');
        const tripInput = document.getElementById('tripNumber');
        const startButton = document.getElementById('startChecklist');
        const checklist = document.getElementById('checklist');
        const inputSection = document.getElementById('inputSection');
        const photoInput = document.getElementById('studentPhoto');
        const uploadButton = document.getElementById('uploadPhoto');

        function checkInputs() {
            const studentValue = studentSelect.value === 'new' ? newStudentInput.value.trim() : studentSelect.value;
            const isNewStudent = studentSelect.value === 'new';
            startButton.disabled = !(guideInput.value.trim() && studentValue && (!isNewStudent || tripInput.value.trim()));
        }

        guideInput.addEventListener('input', () => {
            checkInputs();
            if (guideInput.value.trim()) fetchStudents(guideInput.value);
        });
        studentSelect.addEventListener('change', () => {
            newStudentInput.style.display = studentSelect.value === 'new' ? 'block' : 'none';
            if (studentSelect.value !== 'new' && studentSelect.value) {
                fetchTripNumberAndProgress(studentSelect.value);
            } else {
                tripInput.value = '';
            }
            checkInputs();
        });
        newStudentInput.addEventListener('input', checkInputs);
        tripInput.addEventListener('input', checkInputs);

        window.onload = () => {
            const savedGuide = localStorage.getItem('lastGuide');
            if (savedGuide) {
                guideInput.value = savedGuide;
                fetchStudents(savedGuide);
            }
        };

        function fetchStudents(guideName) {
            fetch(`${SCRIPT_URL}?guideName=${encodeURIComponent(guideName)}`)
                .then(response => response.json())
                .then(data => {
                    studentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</option>';
                    data.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student;
                        option.textContent = student;
                        studentSelect.appendChild(option);
                    });
                    const newOption = document.createElement('option');
                    newOption.value = 'new';
                    newOption.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞';
                    studentSelect.appendChild(newOption);
                    window.tripData = data.trips;
                    window.completedTasksData = data.completedTasks;
                })
                .catch(error => {
                    console.error('Error fetching students:', error);
                    studentSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞</option><option value="new">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞</option>';
                });
        }

        function fetchTripNumberAndProgress(student) {
            if (window.tripData && window.tripData[student]) {
                tripInput.value = window.tripData[student];
            }
        }

        startButton.addEventListener('click', () => {
            localStorage.setItem('lastGuide', guideInput.value);
            inputSection.style.display = 'none';
            checklist.style.display = 'block';
            loadProgress();
        });

        function loadProgress() {
            const student = studentSelect.value === 'new' ? newStudentInput.value : studentSelect.value;
            const storageKey = `checklist_${student}`;
            let progress = JSON.parse(localStorage.getItem(storageKey) || '{}');
            
            // Load completed tasks from Google Sheets if the student is not new
            if (studentSelect.value !== 'new' && window.completedTasksData && window.completedTasksData[student]) {
                const tasksFromSheet = window.completedTasksData[student].split(', ').map(task => task.trim());
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    const labelText = checkbox.nextElementSibling.textContent.trim();
                    if (tasksFromSheet.includes(labelText)) {
                        progress[checkbox.id] = true; // Mark as completed based on sheet data
                    }
                });
            }

            // Update UI based on merged progress
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const isChecked = !!progress[checkbox.id];
                checkbox.checked = isChecked;
                checkbox.nextElementSibling.classList.toggle('completed', isChecked);
            });

            // Save merged progress to localStorage
            localStorage.setItem(storageKey, JSON.stringify(progress));
        }

        function sendToGoogleSheets(student, trip, guide, task, completedTasks, photoData) {
            const data = {
                studentName: student,
                tripNumber: trip,
                guideName: guide,
                task: task,
                completedTasks: completedTasks,
                timestamp: new Date().toISOString(),
                photoData: photoData || null
            };
            fetch(UPDATE_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(error => console.error('Error sending data:', error));
        }

        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = this.nextElementSibling;
                const student = studentSelect.value === 'new' ? newStudentInput.value : studentSelect.value;
                const trip = tripInput.value;
                const guide = guideInput.value;
                const storageKey = `checklist_${student}`;
                let progress = JSON.parse(localStorage.getItem(storageKey) || '{}');

                if (this.checked) {
                    label.classList.add('completed');
                    progress[this.id] = true;
                } else {
                    label.classList.remove('completed');
                    delete progress[this.id];
                }
                localStorage.setItem(storageKey, JSON.stringify(progress));
                
                const completedTasks = Object.keys(progress)
                    .map(id => document.querySelector(`label[for="${id}"]`).textContent.trim())
                    .join(', ');
                sendToGoogleSheets(student, trip, guide, label.textContent, completedTasks);
            });
        });

        uploadButton.addEventListener('click', () => {
            const file = photoInput.files[0];
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!');
                return;
            }
            const student = studentSelect.value === 'new' ? newStudentInput.value : studentSelect.value;
            const trip = tripInput.value;
            const guide = guideInput.value;
            const storageKey = `checklist_${student}`;
            const progress = JSON.parse(localStorage.getItem(storageKey) || '{}');
            const completedTasks = Object.keys(progress)
                .map(id => document.querySelector(`label[for="${id}"]`).textContent.trim())
                .join(', ');

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result.split(',')[1];
                const photoData = {
                    data: base64Data,
                    type: file.type
                };
                sendToGoogleSheets(student, trip, guide, '', completedTasks, photoData);
                alert('–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                photoInput.value = '';
            };
            reader.readAsDataURL(file);
        });
    </script>
</body>
</html>
